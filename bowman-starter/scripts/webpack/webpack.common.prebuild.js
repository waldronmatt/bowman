const path = require('path');
const { CleanWebpackPlugin } = require('clean-webpack-plugin');
const ManifestPlugin = require('webpack-manifest-plugin');
const CopyWebpackPlugin = require('copy-webpack-plugin');

/*
  We have a prebuild script so we can
  use assets (images, etc.) for use in javascript files.

  We must create a manifest
  before webpack grabs js files in webpack.common

  More information can be found in ignore.js
*/

module.exports = {
  // we need to specify an entry so this file can run. 
  entry: ['./ignore.js'],
  output: {
    filename: '[name].js',
    path: path.resolve(__dirname, '../../dist/'),
  },
  plugins: [
    new CleanWebpackPlugin({
      cleanOnceBeforeBuildPatterns: ['static/**/*'],
    }),
    // mapping of assets (images, docs, etc.)
    new ManifestPlugin({
      fileName: 'assets-manifest.json',
      // filter out main.js auto-generated by webpack
      filter: (file) => {
        return file.name.indexOf('main.js')
      },
      /* 
        Remove hash in manifest key
        https://github.com/webpack-contrib/copy-webpack-plugin/issues/104
      */
      map: (file) => {
        file.name = file.name.replace(/(\.[a-f0-9]{8})(\..*)$/, '$2');
        return file;
      },
    }),
    new CopyWebpackPlugin([
      // copy over misc assets
      { from:'./src/static/fonts/', to: 'static/fonts', },
      { from:'./src/static/favicons/', to: '', },
      // files you don't want webpack to compile go below (e.g. vendors)
    ]),
  ],
  performance : {
    hints : 'warning',
  },
};